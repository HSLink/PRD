# 本文档为上位机和下位机的通信文档

上位机和下位机之间通过HID进行通信，如无特殊说明，通信内容默认为json字符串，编码格式为utf-8。

如何特殊说明，以下内容均为上位机主动下发，下位机再进行回复。

该文档中示例的json字符串均被格式化了方便人类阅读，实际通信中不要加空格和换行以及注释。

上位机字段简称为`up`，下位机字段简称为`down`。

## 基础信息

该项为上位机收集下位机基础信息。

### up

- name
  - type: string
  - desc: 该字段为上位机发送的消息名称，用于下位机识别消息类型。此项中固定为`Hello`

```json
{
    "name": "Hello"
}
```

### down

```json
{
    "serial": "123456",
    "model": "HSLink-Pro", 
    "version": "1.0.0",
    "bootloader": "1.0.0" 
}
```

## 设备设置

该项为上位机设置下位机的一些参数。

### up

- name
  - type: string
  - desc: 该字段为上位机发送的消息名称，用于下位机识别消息类型。此项中固定为`settings`
- data
  - type: object
  - desc: 该字段为上位机发送的设置数据
    - boost
      - type: bool
      - desc: 是否开启速度Boost模式
    - swd_port_mode
      - type: enum(String)
      - desc: 选择SWD输出是使用SPI还是GPIO模拟
        - spi
          - desc: SPI模拟
        - gpio
          - desc: GPIO模拟
    - jtag_port_mode
      - type: enum(String)
      - desc: 选择JTAG输出是使用SPI还是GPIO模拟
        - spi
          - desc: SPI模拟
        - gpio
          - desc: GPIO模拟
    - power
      - type: object
      - desc: 电源设置项
        - enable
          - type: bool
          - desc: 上电是否开启输出
        - vref
          - type: float
          - desc: 默认的Vref电平
        - power_on
          - type: bool
          - desc: 是否默认打开电源输出
      - reset
        - type: array
        - desc: 默认复位方式
          - type: enum(String)
          - desc: 复位方式
            - nrst
              - desc: NRST输出
            - por
              - desc: 电源复位（关闭Tvcc和5V输出再打开）
            - swd_soft
              - desc: Arm SWD 软复位
      - led
        - type: bool
        - desc: 是否需要启动RGB LED
      - led_brightness
        - type: int
        - desc: LED亮度设置

```json
{
    "name": "settings",
    "data": {
        "boost": true,
        "swd_port_mode": "spi",
        "jtag_port_mode": "spi",
        "power": {
            "enable": true,
            "vref": 3.3,
            "power_on": true
        },
        "reset": ["nrst", "por"],
        "led": true,
        "led_brightness": 50 
    }
}
```

### down

- status
  - type: enum(String)
  - desc: 设置结果
    - success
      - desc: 设置成功
    - failed
      - desc: 设置失败
- message
  - type: string
  - desc: 设置结果信息，如果设置成功此字符串为空。如果设置失败，可以直接显示给用户

```json
{
    "status": "failed",
    "message": "Settings failed, xxx"
}
```

## 设备升级

升级区分为APP和Bootloader两种，如果文件读取到是uf2文件，那么强制修改为升级APP。

### APP升级

APP升级流程为上位机下发升级指令，收到下位机回复之后下位机会进入升级模式。

APP设计是通过uf2文件进行升级，所以需要上位机选择文件。如果上位机选择的文件为bin或者hex，上位机需要将文件转换为uf2格式。升级只需要将uf2文件复制到虚拟U盘即可。

#### up

- name
  - type: string
  - desc: 该字段为上位机发送的消息名称，用于下位机识别消息类型。此项中固定为`upgrade`

```json
{
    "name": "upgrade"
}
```

#### down

- status
  - type: enum(String)
  - desc: 是否进入升级模式，该字段不会出现其它值
    - success
      - desc: 进入成功

```json
{
    "status": "success"
}
```

### Bootloader升级

Bootloader升级流程为上位机下发升级指令，收到下位机回复之后下位机会进入Bootloader模式。（TODO中

进入升级模式之后，上位机将Bootloader文件裸二进制流直接通过HID发送给下位机即可（可以讨论是否应该加上其它校验方式或者采用其它成熟协议）。

#### up

- name
  - type: string
  - desc: 该字段为上位机发送的消息名称，用于下位机识别消息类型。此项中固定为`upgrade_bootloader`

```json
{
    "name": "upgrade_bootloader"
}
```

#### down

- status
  - type: enum(String)
  - desc: 是否进入升级模式，该字段不会出现其它值
    - success
      - desc: 进入成功

```json
{
    "status": "success"
}
```
